<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkWise AI - AI Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="light-mode">

<aside class="sidebar">
    <div class="logo-section">
        <h1>WorkWise AI</h1>
        <p>
            {% if user.role == "Manager" %}
                Manager Portal
            {% else %}
                Employee Portal
            {% endif %}
        </p>
    </div>

    <nav class="nav-links">
        {% if user.role == "Manager" %}
            <a href="{{ url_for('team_dashboard') }}"
               class="{{ 'active' if request.endpoint == 'team_dashboard' else '' }}">
                <span class="material-icons">dashboard</span> Team Dashboard
            </a>

            <a href="{{ url_for('your_dashboard') }}"
               class="{{ 'active' if request.endpoint == 'your_dashboard' else '' }}">
                <span class="material-icons">person</span> Your Dashboard
            </a>

            <a href="{{ url_for('goals_management') }}"
               class="{{ 'active' if request.endpoint == 'goals_management' else '' }}">
                <span class="material-icons">flag</span> Goals
            </a>

            <a href="{{ url_for('leaderboard') }}"
               class="{{ 'active' if request.endpoint == 'leaderboard' else '' }}">
                <span class="material-icons">leaderboard</span> Leaderboard
            </a>

            <a href="{{ url_for('insights') }}"
               class="{{ 'active' if request.endpoint == 'insights' else '' }}">
                <span class="material-icons">auto_fix_high</span> AI Insights
            </a>

            <a href="#" onclick="openLinkedInModal(event)">
                <span class="material-icons">share</span> LinkedIn Connect
            </a>
        {% else %}
            <a href="{{ url_for('your_dashboard') }}"
               class="{{ 'active' if request.endpoint == 'your_dashboard' else '' }}">
                <span class="material-icons">person</span> Your Dashboard
            </a>

            <a href="{{ url_for('insights') }}"
               class="{{ 'active' if request.endpoint == 'insights' else '' }}">
                <span class="material-icons">auto_fix_high</span> AI Insights
            </a>

            <a href="#" onclick="openLinkedInModal(event)">
                <span class="material-icons">share</span> LinkedIn Connect
            </a>
        {% endif %}
    </nav>

    <div class="utility-section">
        <button id="mode-toggle" onclick="toggleDarkMode()">
            <span class="material-icons">dark_mode</span> 
            <span class="mode-text">Dark Mode</span> 
        </button>
        <a href="{{ url_for('logout') }}" class="logout">
            <span class="material-icons">logout</span> Logout
        </a>
    </div>
</aside>

<main class="main-content">
    <header class="dashboard-header">
        <h2>AI Insights</h2>
        <p>Smart analytics and recommendations for better decisions</p>
    </header>

    <!-- Graph Section -->
    <div class="content-box graph-section">
        <div class="graph-header">
            <h3>Team Performance Analysis</h3>
            <p>Weekly comparison</p>
        </div>
        <div class="chart-container">
            <canvas id="teamPerformanceChart"></canvas>
        </div>
    </div>

    <!-- AI Summary Cards -->
    <div class="ai-summary-cards">
        <!-- Top Performers -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons card-icon green-icon">military_tech</span> Top Performers
            </div>
            <p class="card-subtitle" style="margin-top: 5px;">This week</p>
            <ul class="performer-list">
                {% if top_performers %}
                    {% for performer in top_performers %}
                    <li class="performer-item">
                        <div class="initials">{{ performer.name|first }}{{ performer.name.split()[1]|first if performer.name.split()|length > 1 else '' }}</div>
                        <span class="name">{{ performer.name }}</span>
                        <span class="score-tag green-bg">{{ performer.performance_score }} pts</span>
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="no-data">No top performers data available</li>
                {% endif %}
            </ul>
        </div>

        <!-- Attention Needed -->
        <div class="card">
            <div class="card-title">
                <span class="material-icons card-icon red-icon">warning_amber</span> Attention Needed
            </div>
            <p class="card-subtitle" style="margin-top: 5px;">Needs support</p>
            <ul class="performer-list">
                {% if attention_needed %}
                    {% for emp in attention_needed %}
                    <li class="performer-item">
                        <div class="initials red-initials">{{ emp.name|first }}{{ emp.name.split()[1]|first if emp.name.split()|length > 1 else '' }}</div>
                        <span class="name">{{ emp.name }}</span>
                        <span class="score-tag yellow-bg">{{ emp.performance_score }} pts</span>
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="no-data">No employees need attention</li>
                {% endif %}
            </ul>
        </div>

        <!-- Weekly Report -->
        <div class="card report-card">
            <div class="card-title" style="margin-bottom: 0;">
                <span class="material-icons card-icon blue-icon">description</span> Weekly Report
            </div>
            <div class="report-card-content">
                <h4 class="text-secondary">Comprehensive summary</h4>
                <div class="report-stat">
                    <span>Team KPIs</span>
                    <span class="report-stat-value green-text">+12%</span>
                </div>
                <div class="report-stat">
                    <span>Goal Completion</span>
                    <span class="report-stat-value blue-text">{{ goal_completion_rate }}%</span>
                </div>
                <div class="report-stat">
                    <span>Avg Performance</span>
                    <span class="report-stat-value">{{ avg_performance }}/100</span>
                </div>
                <button class="download-btn">
                    <span class="material-icons icon-sm">download</span> Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- AI Suggestions -->
    <h3 class="suggestions-title"><span class="material-icons icon-blue">psychology</span> AI Suggestions for You</h3>
    <p class="text-secondary" style="margin-bottom: 25px;">Auto-generated insights based on current data and industry benchmarks</p>

    <div class="suggestions-list">
        {% for suggestion in ai_suggestions %}
        <div class="suggestion-item {{ suggestion.type }}">
            <span class="material-icons suggestion-icon
                {% if suggestion.type == 'alert' %}icon-orange
                {% elif suggestion.type == 'info' %}icon-blue
                {% elif suggestion.type == 'success' %}green-icon
                {% endif %}">
                {% if suggestion.type == 'alert' %}warning_amber
                {% elif suggestion.type == 'info' %}tune
                {% elif suggestion.type == 'success' %}trending_up
                {% endif %}
            </span>
            <div class="suggestion-text">
                <h5>{{ suggestion.title }}</h5>
                <p>{{ suggestion.text }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- AI Insights Section -->
    <section id="aiInsightsSection" class="p-4 bg-white rounded-xl shadow mt-4">
        <h2 class="text-2xl font-bold mb-3"></h2>
        <p id="aiInsightsText" 
           class="text-gray-700 text-center italic text-sm cursor-pointer hover:underline" 
           onclick="openPdfReportModal()">
            üìä Full AI insights are available in your floating performance report window.
            <br>
            <span style="color:#2563eb;">Click here to view detailed AI insights.</span>
        </p>
    </section>

    <script>
    async function loadAIInsights() {
        try {
            const res = await fetch("/ai/insights_local");
            const data = await res.json();
            const el = document.getElementById("aiInsightsText");
            if (data.success) {
                el.textContent = data.insights;
            } else {
                el.textContent = "‚ö†Ô∏è Unable to fetch AI insights: " + (data.error || "Unknown error");
            }
        } catch (err) {
            console.error(err);
            document.getElementById("aiInsightsText").textContent = "‚ö†Ô∏è Server unreachable.";
        }
    }
    window.addEventListener("load", loadAIInsights);
    </script>
</main>

<script>
    const body = document.body;
    const modeToggle = document.getElementById('mode-toggle');

    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            updateToggleButton(true);
        }
    });

    function toggleDarkMode() {
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateToggleButton(isDarkMode);
    }

    function updateToggleButton(isDarkMode) {
        const iconSpan = modeToggle.querySelector('.material-icons');
        const textSpan = modeToggle.querySelector('.mode-text'); 
        if (isDarkMode) {
            iconSpan.textContent = 'light_mode';
            textSpan.textContent = ' Light Mode'; 
        } else {
            iconSpan.textContent = 'dark_mode';
            textSpan.textContent = ' Dark Mode'; 
        }
    }
</script>

<script src="{{ url_for('static', filename='js/performanceChart.js') }}"></script>

<!-- LinkedIn Modal -->
<div id="linkedinModal" class="modal-linkedin">
    <div class="modal-content-linkedin">
        <span class="close-btn-linkedin" onclick="closeLinkedInModal()">&times;</span>
        <h3>Post Your Completed Work</h3>
        <p class="modal-description">Share your achievements on LinkedIn through WorkWise AI automation.</p>

        <form id="linkedinWorkForm">
            <div class="input-group-linkedin">
                <label for="workTitle">Title *</label>
                <input type="text" id="workTitle" placeholder="e.g., Completed Dashboard Feature" required>
            </div>

            <div class="input-group-linkedin">
                <label for="workDescription">Description *</label>
                <textarea id="workDescription" rows="5" placeholder="Describe what you accomplished..." required></textarea>
            </div>

            <div class="modal-actions-linkedin">
                <button type="button" class="cancel-linkedin" onclick="closeLinkedInModal()">Cancel</button>
                <button type="submit" class="connect-linkedin-btn">Post to LinkedIn</button>
            </div>
        </form>
    </div>
</div>
<script src="{{ url_for('static', filename='js/linkedin.js') }}"></script>

<!-- PDF Report Modal -->
<div id="pdfReportModal" class="modal" style="display: none;">
  <div class="modal-content pdf-modal-content">
    <span class="close-btn" onclick="closePdfReportModal()">&times;</span>
    <h3 class="modal-title-report">AI Monthly Performance Report</h3>
    <p class="text-secondary modal-subtitle-report">
      Generated on: <span id="report-date">Nov 9, 2025</span>
    </p>

    <div class="report-scroll-area">
      <section class="report-section">
        <h4>üéØ Key Takeaways & Summary</h4>
        <p>
          The team demonstrated a strong focus on high-priority tasks, leading to
          a **+12% increase in Team KPIs** this period. Overall performance
          remains high, but minor score variance indicates a need for targeted
          support for a few employees.
        </p>
      </section>

      <section class="report-section">
        <h4>üìä Performance Metrics</h4>
        <div class="report-stat-grid">
          <div>
            <p>Team Health Score:</p>
            <p class="stat-value">{{ avg_performance }}/100</p>
          </div>
          <div>
            <p>Goal Completion Rate:</p>
            <p class="stat-value blue-text">{{ goal_completion_rate }}%</p>
          </div>
          <div>
            <p>Total Commits:</p>
            <p class="stat-value">{{ total_commits or 3741 }}</p>
          </div>
        </div>
      </section>

      <section class="report-section">
        <h4>‚≠ê Top Performer Spotlight</h4>
        {% if top_performers %}
        <p>
          Congratulations to **{{ top_performers[0].name }}**
          ({{ top_performers[0].performance_score }} pts) for leading the team
          this period.
        </p>
        {% else %}
        <p>No top performers data available this period.</p>
        {% endif %}
      </section>

      <!-- ‚úÖ Single correct section -->
      <section class="report-section" id="dynamic-ai-insights">
        <h4>üìù Detailed AI Recommendations</h4>
        <p id="ai-insights-loading">Fetching latest AI insights...</p>
      </section>
    </div>

    <div class="modal-actions-report">
      <button class="download-pdf-btn" onclick="confirmPdfDownload()">
        Download PDF
      </button>
    </div>
  </div>
</div>

<script>
async function loadDynamicAIInsights() {
  const target = document.getElementById("dynamic-ai-insights");
  const loading = document.getElementById("ai-insights-loading");
  loading.textContent = "Fetching latest AI insights...";

  try {
    const response = await fetch("/ai/insights_report", { cache: "no-store" });
    const data = await response.json();

    if (data.success && data.insights && data.insights.trim() !== "") {
      loading.remove();

      // Format Markdown-style content into HTML
      const formatted = data.insights
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/^(\d+)\.\s/gm, "<br><strong>$1.</strong> ")
        .replace(/\n- /g, "<br>‚Ä¢ ")
        .replace(/\n/g, "<br>");

      target.insertAdjacentHTML(
        "beforeend",
        `
        <div class="ai-insights-content"
             style="font-size:14px;line-height:1.6;color:#333;padding-top:6px;">
            ${formatted}
        </div>`
      );
    } else {
      loading.textContent = "‚ö†Ô∏è No AI insights available. Try again.";
    }
  } catch (err) {
    console.error(err);
    loading.textContent = "‚ö†Ô∏è Unable to fetch insights from server.";
  }
}

// ‚úÖ Unified function ‚Äî triggers AI load when modal opens
const pdfReportModal = document.getElementById("pdfReportModal");

function openPdfReportModal() {
  pdfReportModal.style.display = "flex";
  document.getElementById("report-date").textContent =
    new Date().toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });

  // Clear old insights and load new
  const dynamicSection = document.getElementById("dynamic-ai-insights");
  dynamicSection.querySelectorAll(".ai-insights-content").forEach((el) =>
    el.remove()
  );
  loadDynamicAIInsights();
}

function closePdfReportModal() {
  pdfReportModal.style.display = "none";
}

function confirmPdfDownload() {
  closePdfReportModal();
  const loading = document.createElement("div");
  loading.textContent = "‚è≥ Generating AI Report... Please wait.";
  loading.style.cssText =
    "position:fixed;top:10px;right:10px;background:#2563eb;color:white;padding:10px 14px;border-radius:6px;";
  document.body.appendChild(loading);

  const link = document.createElement("a");
  link.href = "/download_ai_report";
  link.download = "WorkWise_AI_Report.pdf";
  document.body.appendChild(link);
  link.click();
  setTimeout(() => {
    document.body.removeChild(link);
    document.body.removeChild(loading);
  }, 4000);
}

document.addEventListener("DOMContentLoaded", () => {
  const cardDownloadBtn = document.querySelector(".report-card .download-btn");
  if (cardDownloadBtn)
    cardDownloadBtn.setAttribute("onclick", "openPdfReportModal()");
});

window.onclick = function (event) {
  if (event.target == pdfReportModal) closePdfReportModal();
};
</script>


</body>
</html>
