<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkWise AI - Goal Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/goals-styles.css') }}">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</head>

<body class="light-mode">

    <aside class="sidebar">
        <div class="logo-section">
            
            <h1>WorkWise AI</h1>
            <p>Manager Portal</p>
        </div>

        <nav class="nav-links">
            <a href="{{ url_for('team_dashboard') }}"><span class="material-icons">dashboard</span> Team Dashboard</a>
            <a href="{{ url_for('your_dashboard') }}"><span class="material-icons">person</span> Your Dashboard</a>
            <a href="{{ url_for('goals_management') }}" class="active"><span class="material-icons">flag</span> Goals</a>
            <a href="{{ url_for('leaderboard') }}"><span class="material-icons">leaderboard</span> Leaderboard</a>
            <a href="{{ url_for('insights') }}"><span class="material-icons">auto_fix_high</span> AI Insights</a>
            <a href="#" onclick="openLinkedInModal(event)">
                <span class="material-icons">share</span> LinkedIn Connect
            </a>
        </nav>

        <div class="utility-section">
            <button id="mode-toggle" onclick="toggleDarkMode()">
                <span class="material-icons">dark_mode</span> <span class="mode-text">Dark Mode</span>
            </button>
            <a href="{{ url_for('logout') }}" class="logout">
                <span class="material-icons">logout</span> Logout
            </a>
        </div>
    </aside>

    <main class="main-content">
        <header class="dashboard-header">
            <h2>Goal Management</h2>
            <p>Assign tasks and track team member progress.</p>
        </header>

        <div class="content-box">
            <div class="goal-assignment-header">
                <h3>Assign New Goal</h3>
                <button class="assign-button" onclick="openGoalModal()">
                    <span class="material-icons">add_task</span> Assign Goal
                </button>
            </div>

            <p class="text-secondary">Use the button above to assign a new goal to a team member.</p>
        </div>

        <div class="content-box">
            <h3>Currently Assigned Goals</h3>
            <div class="goal-table-container">
                <table class="goal-table">
                    <thead>
                        <tr>
                            <th>Goal Title</th>
                            <th>Assigned To</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="assignedGoalsBody">
                        {% for goal in assigned_goals %}
                        <tr>
                            <td>{{ goal.title }}</td>
                            <td>{{ goal.employee.name }}</td>
                            <td>{{ goal.due_date.strftime('%Y-%m-%d') if goal.due_date else 'N/A' }}</td>
                            <td>
                                <span class="status-badge">{{ goal.status }}</span>
                            </td>
                            <td>
                                <button onclick="markGoalComplete({{ goal.id }})" class="action-button feedback">Complete</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not assigned_goals %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--color-light-grey);">No active goals assigned yet.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="content-box">
            <h3>Recent Completed Goals</h3>
            <div class="goal-table-container">
                <table class="goal-table">
                    <thead>
                        <tr>
                            <th>Goal Title</th>
                            <th>Completed By</th>
                            <th>Completion Date</th>
                        </tr>
                    </thead>
                    <tbody id="completedGoalsBody">
                        {% for goal in completed_goals %}
                        <tr>
                            <td>{{ goal.title }}</td>
                            <td>{{ goal.employee.name }}</td>
                            <td>{{ goal.completion_date.strftime('%Y-%m-%d') if goal.completion_date else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                        {% if not completed_goals %}
                        <tr>
                            <td colspan="3" style="text-align: center; color: var(--color-light-grey);">No goals completed recently.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Goal Assignment Modal -->
    <div id="goalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeGoalModal()">&times;</span>

            <h3>Assign a New Goal</h3>
            <form id="assignGoalForm" onsubmit="submitGoalAssignment(event)">
                <div class="input-group">
                    <label for="goalTitle">Goal/Task Description</label>
                    <input type="text" id="goalTitle" name="goalTitle" placeholder="e.g., Complete Flask API for user auth" required>
                </div>

                <div class="input-group">
                    <label for="employeeSelect">Assign Employee</label>
                    <select id="employeeSelect" name="employeeId" required>
                        <option value="">-- Select Team Member --</option>
                        {% for employee in all_employees %}
                        <option value="{{ employee.id }}">{{ employee.name }} ({{ employee.position }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label for="dueDate">Due Date</label>
                    <input type="date" id="dueDate" name="dueDate" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="cancel" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="assign-button">Assign Goal</button>
                </div>
            </form>
        </div>
    </div>

<script>
// Modal Functions
function openGoalModal() {
    document.getElementById('goalModal').style.display = 'flex';
}

function closeGoalModal() {
    document.getElementById('goalModal').style.display = 'none';
    document.getElementById('assignGoalForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('goalModal');
    if (event.target === modal) {
        closeGoalModal();
    }
}

// Submit Goal Assignment
function submitGoalAssignment(event) {
    event.preventDefault();

    const goalTitle = document.getElementById('goalTitle').value;
    const employeeId = document.getElementById('employeeSelect').value;
    const dueDate = document.getElementById('dueDate').value;

    fetch('/assign_goal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: goalTitle,
            employee_id: employeeId,
            due_date: dueDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Goal assigned successfully!');
            closeGoalModal();
            window.location.reload();
        } else {
            alert(`❌ Error: ${data.message}`);
        }
    })
    .catch(error => {
        alert('❌ Server Error: Could not assign goal');
        console.error(error);
    });
}

// Mark Goal as Complete
function markGoalComplete(goalId) {
    if (!confirm('Mark this goal as complete?')) {
        return;
    }

    fetch('/complete_goal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ goal_id: goalId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Goal marked as complete!');
            window.location.reload();
        } else {
            alert(`❌ Error: ${data.message}`);
        }
    })
    .catch(error => {
        alert('❌ Server Error');
        console.error(error);
    });

}


// LinkedIn Modal (placeholder - implement as needed)
function openLinkedInModal(event) {
    event.preventDefault();
    alert('LinkedIn Connect feature coming soon!');
}
</script>
    <div id="linkedinModal" class="modal-linkedin">
        <div class="modal-content-linkedin">
            <span class="close-btn-linkedin" onclick="closeLinkedInModal()">&times;</span>
            <h3>Post Your Completed Work</h3>
            <p class="modal-description">Share your achievements on LinkedIn through WorkWise AI automation.</p>

            <form id="linkedinWorkForm">
                <div class="input-group-linkedin">
                    <label for="workTitle">Title *</label>
                    <input type="text" id="workTitle" placeholder="e.g., Completed Dashboard Feature" required>
                </div>

                <div class="input-group-linkedin">
                    <label for="workDescription">Description *</label>
                    <textarea id="workDescription" rows="5" placeholder="Describe what you accomplished..." required></textarea>
                </div>

                <div class="modal-actions-linkedin">
                    <button type="button" class="cancel-linkedin" onclick="closeLinkedInModal()">Cancel</button>
                    <button type="submit" class="connect-linkedin-btn">Post to LinkedIn</button>
                </div>
            </form>
        </div>
    </div>
    <!-- LinkedIn Modal END -->

    <!-- LinkedIn JS -->
    <script src="{{ url_for('static', filename='js/linkedin.js') }}"></script>

    <script>
    const body = document.body;
    const modeToggle = document.getElementById('mode-toggle');

    // Load saved theme on page load (PERSISTENCE LOGIC)
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            updateToggleButton(true);
        }
    });

    // Toggle function (usually in theme.js, but duplicated here for completeness)
    function toggleDarkMode() {
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateToggleButton(isDarkMode);
    }

    // Update button text/icon (CRITICAL for button appearance)
    function updateToggleButton(isDarkMode) {
        const iconSpan = modeToggle.querySelector('.material-icons');
        const textSpan = modeToggle.querySelector('.mode-text'); 

        if (isDarkMode) {
            iconSpan.textContent = 'light_mode';
            textSpan.textContent = ' Light Mode'; 
        } else {
            iconSpan.textContent = 'dark_mode';
            textSpan.textContent = ' Dark Mode'; 
        }
    }
</script>

</body>
</html>