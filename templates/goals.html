<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkWise AI - Goal Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/goals-styles.css') }}">
    
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</head>

<body class="light-mode">

    <aside class="sidebar">
        <div class="logo-section">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#007BFF" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM14.5 8C15.33 8 16 8.67 16 9.5C16 10.33 15.33 11 14.5 11C13.67 11 13 10.33 13 9.5C13 8.67 13.67 8 14.5 8ZM9.5 8C10.33 8 11 8.67 11 9.5C11 10.33 10.33 11 9.5 11C8.67 11 8 10.33 8 9.5C8 8.67 8.67 8 9.5 8ZM12 19.2C9.5 19.2 7.4 17.67 6.6 15.4H17.4C16.6 17.67 14.5 19.2 12 19.2Z"/>
            </svg>
            <h1>WorkWise AI</h1>
            <p>Manager Portal</p>
        </div>

        <nav class="nav-links">
            <a href="{{ url_for('team_dashboard') }}"><span class="material-icons">dashboard</span> Team Dashboard</a>
            <a href="{{ url_for('your_dashboard') }}"><span class="material-icons">person</span> Your Dashboard</a>
            <a href="{{ url_for('goals_management') }}" class="active"><span class="material-icons">flag</span> Goals</a>
            <a href="{{ url_for('leaderboard') }}"><span class="material-icons">leaderboard</span> Leaderboard</a>
            <a href="{{ url_for('insights') }}"><span class="material-icons">auto_fix_high</span> AI Insights</a>
        </nav>

        <div class="utility-section">
            <button id="mode-toggle" onclick="toggleDarkMode()">
                <span class="material-icons">dark_mode</span> <span class="mode-text">Dark Mode</span>
            </button>
            <a href="{{ url_for('logout') }}" class="logout">
                <span class="material-icons">logout</span> Logout
            </a>
        </div>
    </aside>

    <main class="main-content">
        <header class="dashboard-header">
            <h2>Goal Management</h2>
            <p>Assign tasks and track team member progress.</p>
        </header>

        <div class="content-box">
            <div class="goal-assignment-header">
                <h3>Assign New Goal</h3>
                <button class="assign-button" onclick="openGoalModal()">
                    <span class="material-icons">add_task</span> Assign Goal
                </button>
            </div>
            
            <p class="text-secondary">Use the button above to assign a new goal to a team member.</p>
        </div>

        <div class="content-box">
            <h3>Currently Assigned Goals</h3>
            <div class="goal-table-container">
                <table class="goal-table">
                    <thead>
                        <tr>
                            <th>Goal Title</th>
                            <th>Assigned To</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="assignedGoalsBody">
                        {% for goal in assigned_goals %}
                        <tr>
                            <td>{{ goal.title }}</td>
                            <td>{{ goal.employee_name }}</td>
                            <td>{{ goal.due_date }}</td>
                            <td>
                                <span class="status-badge status-{{ goal.status_class }}">{{ goal.status }}</span>
                            </td>
                            <td><button onclick="markGoalComplete({{ goal.id }})" class="action-button feedback">Complete</button></td>
                        </tr>
                        {% endfor %}
                        {% if not assigned_goals %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--color-light-grey);">No active goals assigned yet.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="content-box">
            <h3>Recent Completed Goals</h3>
            <div class="goal-table-container">
                <table class="goal-table">
                    <thead>
                        <tr>
                            <th>Goal Title</th>
                            <th>Completed By</th>
                            <th>Completion Date</th>
                        </tr>
                    </thead>
                    <tbody id="completedGoalsBody">
                         {% for goal in completed_goals %}
                        <tr>
                            <td>{{ goal.title }}</td>
                            <td>{{ goal.employee_name }}</td>
                            <td>{{ goal.completion_date }}</td>
                        </tr>
                        {% endfor %}
                        {% if not completed_goals %}
                        <tr>
                            <td colspan="3" style="text-align: center; color: var(--color-light-grey);">No goals completed recently.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
    </main>

    <div id="goalModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeGoalModal()">&times;</span>
            
            <h3>Assign a New Goal</h3>
            <form id="assignGoalForm" onsubmit="submitGoalAssignment(event)">
                <div class="input-group">
                    <label for="goalTitle">Goal/Task Description</label>
                    <input type="text" id="goalTitle" name="goalTitle" placeholder="e.g., Complete Flask API for user auth" required>
                </div>
                
                <div class="input-group">
                    <label for="employeeSelect">Assign Employee</label>
                    <select id="employeeSelect" name="employeeId" required>
                        <option value="">-- Select Team Member --</option>
                        {% for employee in all_employees %}
                        <option value="{{ employee.id }}">{{ employee.name }} ({{ employee.role }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label for="dueDate">Due Date</label>
                    <input type="date" id="dueDate" name="dueDate" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="cancel" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="assign-button">Assign Goal</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // NOTE: Dark mode logic and updateToggleButton() should be available globally via theme.js 
    // or embedded here if not using an external file.

    // Close modal on outside click (if not defined globally)
    const goalModal = document.getElementById('goalModal');
    window.onclick = function(event) {
        if (event.target === goalModal) closeGoalModal();
    }

    // ========== GOAL MODAL LOGIC (JavaScript) ==========
    
    function openGoalModal() {
        goalModal.style.display = 'flex';
        // Set the minimum due date to tomorrow to prevent selecting past dates
        const today = new Date();
        today.setDate(today.getDate() + 1);
        const minDate = today.toISOString().split('T')[0];
        document.getElementById('dueDate').setAttribute('min', minDate);
    }

    function closeGoalModal() {
        goalModal.style.display = 'none';
        document.getElementById('assignGoalForm').reset(); // Clear form on close
    }

    function submitGoalAssignment(event) {
        event.preventDefault(); // Stop default form submission
        
        const goalTitle = document.getElementById('goalTitle').value;
        const employeeSelect = document.getElementById('employeeSelect');
        const employeeId = employeeSelect.value;
        // Get the full text for the alert message
        const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text.split('(')[0].trim(); 
        const dueDate = document.getElementById('dueDate').value;

        if (!employeeId) {
            alert("Please select an employee.");
            return;
        }

        // 1. Prepare data for backend (using JSON format)
        const postData = {
            title: goalTitle,
            employee_id: employeeId,
            due_date: dueDate
        };

        // 2. Send data to Flask backend (uncomment and implement this in main.py)
        /*
        fetch('/assign_goal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Goal assigned: "${goalTitle}" to ${employeeName}.`);
                closeGoalModal();
                window.location.reload(); // Reload page to show new goal
            } else {
                alert(`❌ Error assigning goal: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            alert('❌ Failed to connect to server to assign goal.');
        });
        */
        
        // Simulating a successful backend call
        console.log('Goal Assignment Data:', postData);
        alert(`✅ Goal assigned: "${goalTitle}" to ${employeeName}. (Backend Simulation)`);
        closeGoalModal();
    }
    
    function markGoalComplete(goalId) {
        if (confirm(`Are you sure you want to mark Goal #${goalId} as complete? This action is irreversible.`)) {
            // Placeholder: Send completion update to the backend
            console.log(`Sending request to mark goal ${goalId} as complete.`);
            
            /*
            fetch('/complete_goal/' + goalId, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Goal #${goalId} marked complete!`);
                    window.location.reload(); 
                } else {
                    alert(`❌ Error: ${data.message}`);
                }
            });
            */
            
            alert(`Goal #${goalId} marked complete! (Backend Simulation)`);
        }
    }
    
</script>
</body>
</html>